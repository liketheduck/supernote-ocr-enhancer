# Supernote OCR Enhancer - Docker Compose Configuration
# Processes .note files using the local MLX-VLM OCR API
#
# Usage: docker compose --env-file .env.local up
# Or create a symlink: ln -s .env.local .env

services:
  supernote-ocr-enhancer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: supernote-ocr-enhancer
    restart: unless-stopped  # Keep running for cron jobs
    environment:
      # OCR API endpoint (host machine)
      - OCR_API_URL=http://host.docker.internal:8100
      # Processing settings
      - SUPERNOTE_DATA_PATH=/supernote/data
      - PROCESS_INTERVAL=${PROCESS_INTERVAL:-0}  # 0 = single run, >0 = interval in seconds
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Write settings
      - WRITE_TO_NOTE=${WRITE_TO_NOTE:-true}     # Write OCR data back to .note files
      - CREATE_BACKUPS=${CREATE_BACKUPS:-true}   # Create backups before modifying
      - RESET_DATABASE=${RESET_DATABASE:-false}  # Clear history and reprocess all files
      # Sync server coordination (optional - set in .env.local if using sync server)
      - SYNC_SERVER_COMPOSE=${SYNC_SERVER_COMPOSE:-}
      - SYNC_SERVER_ENV=${SYNC_SERVER_ENV:-}
    volumes:
      # Supernote data (read-write to inject OCR data)
      # Set SUPERNOTE_DATA_PATH in .env.local
      - ${SUPERNOTE_DATA_PATH:?Set SUPERNOTE_DATA_PATH in .env.local}:/supernote/data
      # Local persistent storage for tracking state and backups
      - ./data:/app/data
      # Docker socket for sync server control (optional)
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - .env.local
    extra_hosts:
      # Ensure host.docker.internal resolves on all platforms
      - "host.docker.internal:host-gateway"
