# Supernote OCR Enhancer - Docker Compose Configuration
# Processes .note files using the local MLX-VLM OCR API
#
# Usage: docker compose --env-file .env.local up
# Or create a symlink: ln -s .env.local .env

services:
  ocr-enhancer:
    image: supernote-ocr-enhancer:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: supernote-ocr-enhancer
    restart: unless-stopped  # Keep running for cron jobs
    deploy:
      resources:
        limits:
          memory: 512M        # Hard limit - container will be killed if exceeded
        reservations:
          memory: 200M        # Soft reservation - guaranteed minimum
    environment:
      # Container timezone (matches host for cron scheduling)
      - TZ=America/New_York
      # OCR API endpoint (host machine) - must use host.docker.internal from container
      - OCR_API_URL=http://host.docker.internal:8100
      # Data path inside container
      - DATA_PATH=/app/data
      # Processing settings
      - SUPERNOTE_DATA_PATH=/supernote/data
      - PROCESS_INTERVAL=${PROCESS_INTERVAL:-0}  # 0 = single run, >0 = interval in seconds
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Write settings
      - WRITE_TO_NOTE=${WRITE_TO_NOTE:-true}     # Write OCR data back to .note files
      - CREATE_BACKUPS=${CREATE_BACKUPS:-true}   # Create backups before modifying
      - RESET_DATABASE=${RESET_DATABASE:-false}  # Clear history and reprocess all files
      # Storage mode: personal_cloud (default), mac_app, or none
      - STORAGE_MODE=${STORAGE_MODE:-}
      # Personal Cloud sync server coordination (default when configured)
      - SYNC_SERVER_COMPOSE=${SYNC_SERVER_COMPOSE:-}
      - SYNC_SERVER_ENV=${SYNC_SERVER_ENV:-}
      # Mac app mode (alternative to Personal Cloud)
      - MACAPP_DATABASE_PATH=${MACAPP_DATABASE_PATH:-}
      - MACAPP_NOTES_PATH=${MACAPP_NOTES_PATH:-}
      # Text export: save OCR text to .txt files (optional)
      - OCR_TXT_EXPORT_ENABLED=${OCR_TXT_EXPORT_ENABLED:-false}
      # Inside container, text exports go to /txt-export (mapped via volume below)
      - OCR_TXT_EXPORT_PATH=${OCR_TXT_EXPORT_ENABLED:+/txt-export}
    volumes:
      # Supernote data (read-write to inject OCR data)
      # Set SUPERNOTE_DATA_PATH in .env.local
      - ${SUPERNOTE_DATA_PATH:?Set SUPERNOTE_DATA_PATH in .env.local}:/supernote/data
      # Local persistent storage for tracking state and backups
      - ./data:/app/data
      # Docker socket for accessing MariaDB container (Personal Cloud sync database updates)
      # This allows the container to update the sync database while the sync server runs
      - /var/run/docker.sock:/var/run/docker.sock
      # Text export directory (used when OCR_TXT_EXPORT_ENABLED=true)
      # Host path: set OCR_TXT_EXPORT_PATH in .env.local, defaults to ./data/txt-export
      - ${OCR_TXT_EXPORT_PATH:-./data/txt-export}:/txt-export
    env_file:
      - .env.local
    extra_hosts:
      # Ensure host.docker.internal resolves on all platforms
      - "host.docker.internal:host-gateway"
